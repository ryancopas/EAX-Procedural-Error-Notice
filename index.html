<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Procedural Error Notice – Fill & Submit</title>
<style>
  body {font-family:Arial,sans-serif;max-width:900px;margin:2rem auto;background:#f7f9fc;padding:1rem;}
  h1 {text-align:center;color:#2c3e50;}
  label {display:block;margin-top:.8rem;}
  input, textarea, select {width:100%;padding:.4rem;margin-top:.2rem;}
  .checkboxes {display:flex;flex-wrap:wrap;gap:.5rem;}
  .checkboxes label {display:inline-block;width:auto;}
  button {margin-top:1rem;padding:.6rem 1.2rem;background:#0066cc;color:#fff;border:none;border-radius:4px;cursor:pointer;}
  button:hover {background:#004999;}
</style>
</head>
<body>

<h1>Procedural Error Notice (GMM 11.4‑01)</h1>

<form id="pdfForm">

  <!-- ==== REQUIRED TEXT / DATE FIELDS ==== -->
  <label>Date of Notice
    <input type="date" name="date_of_notice" required>
  </label>

  <label>Addressee
    <input type="text" name="addressee" required>
  </label>

  <label>STA
    <input type="text" name="sta" required>
  </label>

  <label>Date of Error
    <input type="date" name="date_of_error" required>
  </label>

  <label>Person Responsible for Error
    <input type="text" name="person_responsible_error" required>
  </label>

  <label>ID No. (person)
    <input type="text" name="person_responsible_id" required>
  </label>

  <label>Aircraft / Equipment
    <input type="text" name="aircraft_equipment" required>
  </label>

  <label>Originator Name
    <input type="text" name="originator_name" required>
  </label>

  <label>ID No. (originator)
    <input type="text" name="originator_id" required>
  </label>

  <label>Reply Due Date
    <input type="date" name="reply_due_date" required>
  </label>

  <label>Log Page and Originating Document
    <input type="text" name="originating_document" required>
  </label>

  <label>Explanation
    <textarea name="explanation" rows="8" required></textarea>
  </label>

  <!-- ==== CHECKBOX GROUP (at least one required) ==== -->
  <fieldset style="margin-top:1rem;">
    <legend>Errors (check at least one)</legend>
    <div class="checkboxes">
      <label><input type="checkbox" name="missing_attachment"> Missing Certs/Attachments</label>
      <label><input type="checkbox" name="missing_signature"> Missing Signature</label>
      <label><input type="checkbox" name="incomplete_entry"> Incomplete Entry</label>
      <label><input type="checkbox" name="incorrect_entry"> Incorrect Entry</label>
      <label><input type="checkbox" name="legibility"> Legibility</label>
    </div>
  </fieldset>

  <!-- ==== OPTIONAL ATTACHMENTS (extra PDFs) ==== -->
  <label>Attach other PDF files (optional)
    <input type="file" id="extraFiles" multiple accept=".pdf">
  </label>

  <button type="button" id="submitBtn">Submit</button>
</form>

<!-- --------------------------------------------------------------
     Libraries (loaded from CDN)
     -------------------------------------------------------------- -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
(async () => {
  const { PDFDocument } = PDFLib;

  // -----------------------------------------------------------------
  // Helper – ensure at least one checkbox is checked
  // -----------------------------------------------------------------
  function atLeastOneChecked() {
    const names = [
      'incomplete_entry',
      'incorrect_entry',
      'missing_certs',
      'missing_signature',
      'legibility'
    ];
    return names.some(n => document.querySelector(`input[name="${n}"]:checked`));
  }

  // -----------------------------------------------------------------
  // Main submit handler
  // -----------------------------------------------------------------
  document.getElementById('submitBtn').addEventListener('click', async () => {
    const form = document.getElementById('pdfForm');

    // ---- 1️⃣ HTML5 validation (required attributes) ----
    if (!form.reportValidity()) return;   // stops if any required field is empty

    // ---- 2️⃣ Ensure at least one checkbox is ticked ----
    if (!atLeastOneChecked()) {
      alert('Please check at least one of the error boxes.');
      return;
    }

    // ---- 3️⃣ Gather all field values (including checkboxes) ----
    const values = {};
    new FormData(form).forEach((v, k) => {
      // For checkboxes we store "Yes" when checked, otherwise empty string
      if (['incomplete_entry','incorrect_entry','missing_certs','missing_signature','legibility'].includes(k)) {
        values[k] = v ? 'Yes' : '';
      } else {
        values[k] = v;
      }
    });

    // ---- 4️⃣ Load the original PDF template ----
    const templateUrl = 'https://drive.google.com/file/d/1LsLG7kr-WgAR0Xjo-P40T8A6dlWOLjK3';   // <<<=== replace with your PDF URL
    const existingPdfBytes = await fetch(templateUrl).then(r => r.arrayBuffer());

    // ---- 5️⃣ Fill the PDF with the collected values ----
    const pdfDoc = await PDFDocument.load(existingPdfBytes);
    const pdfForm = pdfDoc.getForm();

    // Helper: set a field only if it exists in the template
    const setIfExists = (name, value) => {
      const field = pdfForm.getFieldMaybe(name);
      if (!field) return;   // field not present – ignore
      if (field.constructor.name === 'PDFCheckBox') {
        if (value === 'Yes') field.check(); else field.uncheck();
      } else {
        field.setText(value);
      }
    };

    Object.entries(values).forEach(([name, val]) => setIfExists(name, val));

    // Flatten so the fields become ordinary content (cannot be edited later)
    pdfDoc.flatten();

    const filledPdfBytes = await pdfDoc.save();

    // ---- 6️⃣ Build a multipart/form‑data payload for the Apps Script ----
    const formData = new FormData();

    // The filled PDF (field name "filled_pdf")
    const filledBlob = new Blob([filledPdfBytes], {type: 'application/pdf'});
    formData.append('filled_pdf', filledBlob, 'Procedural_Error_Filled.pdf');

    // Extra files the user selected (field name "extra_files")
    const extraInput = document.getElementById('extraFiles');
    for (const file of extraInput.files) {
      formData.append('extra_files', file, file.name);
    }

    // Add all plain‑text fields (they will be written to the sheet)
    Object.entries(values).forEach(([k, v]) => formData.append(k, v));

    // ---- 7️⃣ POST to the Apps Script web‑app ----
    try {
      await fetch('https://script.google.com/macros/s/AKfycbyj7bXnqc2y-lVgLI3_AZed2KEZZceprgQ48I47LvwQnCq7laYvRYecHIQoixIBhkcFMg/exec', {
        method: 'POST',
        mode: 'no-cors',          // Apps Script accepts no‑CORS POSTs
        body: formData
      });
    } catch (e) {
      console.warn('POST to Apps Script failed (non‑blocking).', e);
    }

    // ---- 8️⃣ Offer the filled PDF for immediate download ----
    const downloadBlob = new Blob([filledPdfBytes], {type: 'application/pdf'});
    const url = URL.createObjectURL(downloadBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'PEN_Filled.pdf';
    a.click();
    URL.revokeObjectURL(url);

    alert('✅ Form submitted and PDF downloaded. Attachments have been saved to Drive; data logged to the spreadsheet.');
    form.reset();
  });
})();
</script>

</body>
</html>
