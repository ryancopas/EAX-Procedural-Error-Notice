<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Procedural Error Notice – Submission</title>
<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    max-width: 800px;
    margin: 2rem auto;
    line-height: 1.5;
    color: #333;
  }
  h1 { text-align: center; }
  label { display: block; margin-top: 0.8rem; }
  input[type=text],
  input[type=date],
  textarea,
  select {
    width: 100%;
    padding: 0.4rem;
    margin-top: 0.2rem;
    box-sizing: border-box;
  }
  .checkboxes {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 0.4rem;
  }
  .checkboxes label {
    display: flex;
    align-items: center;
  }
  .error { color: #c00; margin-top: 0.5rem; display: none; }
  button {
    margin-top: 1.5rem;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>Procedural Error Notice</h1>

<form id="errorForm">

  <!-- ==== TEXT/DATES ==== -->
  <label>Date of Notice
    <input type="date" name="date_of_notice" required>
  </label>

  <label>Addressee
    <input type="text" name="addressee" required>
  </label>

  <label>STA
    <input type="text" name="sta" required>
  </label>

  <label>Date of Error
    <input type="date" name="date_of_error" required>
  </label>

  <label>Person Responsible for Error
    <input type="text" name="person_responsible_error" required>
  </label>

  <label>ID No.
    <input type="text" name="person_responsible_id" required>
  </label>

  <label>Aircraft / Equipment
    <input type="text" name="aircraft_equipment" required>
  </label>

  <label>Originator Name
    <input type="text" name="originator_name" required>
  </label>

  <label>Originator ID
    <input type="text" name="originator_id" required>
  </label>

  <label>Reply Due Date
    <input type="date" name="reply_due_date" required>
  </label>

  <label>Log Page / Originating Document
    <input type="text" name="originating_document" required>
  </label>

  <!-- ==== CLASSIFICATION CHECKBOXES (at least one required) ==== -->
  <fieldset>
    <legend>Classification (choose at least one)</legend>
    <div class="checkboxes" id="classificationGroup">
      <label><input type="checkbox" name="classification" value="missing_attachment"> Missing Certs/Attachments</label>
      <label><input type="checkbox" name="classification" value="missing_signature"> Missing Signature</label>
      <label><input type="checkbox" name="classification" value="incomplete_entry"> Incomplete Entry</label>
      <label><input type="checkbox" name="classification" value="incorrect_entry"> Incorrect Entry</label>
      <label><input type="checkbox" name="classification" value="legibility"> Legibility</label>
    </div>
    <div class="error" id="classError">Please select at least one classification.</div>
  </fieldset>

  <!-- ==== EXPLANATION ==== -->
  <label>Explanation
    <textarea name="explanation" rows="4" required></textarea>
  </label>

  <!-- ==== OPTIONAL PDF ATTACHMENTS ==== -->
  <label>Attach PDF files (optional – you can select several)
    <input type="file" id="pdfFiles" accept=".pdf" multiple>
  </label>

  <button type="submit">Submit</button>
</form>

<script>
/* --------------------------------------------------------------
   1️⃣  CONFIG – replace with the URL of your PDF‑filler service
   -------------------------------------------------------------- */
// Example: const BACKEND_URL = 'https://pdf-filler-abcde-uc.a.run.app/fill-pdf';
const BACKEND_URL = 'YOUR_BACKEND_URL_HERE';

/* --------------------------------------------------------------
   2️⃣  Helper – convert a File object → base64 string
   -------------------------------------------------------------- */
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]); // strip data:…;base64,
    reader.onerror = err => reject(err);
    reader.readAsDataURL(file);
  });
}

/* --------------------------------------------------------------
   3️⃣  Form submit handler
   -------------------------------------------------------------- */
document.getElementById('errorForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  /* ---------- 3a. Validate at least one classification checkbox ---------- */
  const checkedBoxes = Array.from(document.querySelectorAll('#classificationGroup input:checked'));
  const classErrorEl = document.getElementById('classError');
  if (checkedBoxes.length === 0) {
    classErrorEl.style.display = 'block';
    return;
  } else {
    classErrorEl.style.display = 'none';
  }

  /* ---------- 3b. Gather all form fields into a plain object ---------- */
  const formData = new FormData(e.target);
  const formObj = {};

  for (const [key, value] of formData.entries()) {
    // Handle multi‑value fields (checkboxes)
    if (formObj[key]) {
      if (!Array.isArray(formObj[key])) formObj[key] = [formObj[key]];
      formObj[key].push(value);
    } else {
      formObj[key] = value;
    }
  }

  // Turn the classification checkboxes into a comma‑separated string
  formObj.classification = checkedBoxes.map(cb => cb.value).join(', ');

  /* ---------- 3c. Process optional PDF uploads ---------- */
  const pdfInput = document.getElementById('pdfFiles');
  const files = Array.from(pdfInput.files);          // may be empty
  const encodedFiles = await Promise.all(
    files.map(async (f) => ({
      name: f.name,
      mimeType: f.type,
      data: await fileToBase64(f)
    }))
  );

  /* ---------- 3d. Build the payload for the backend ---------- */
  const payload = {
    form: formObj,
    files: encodedFiles          // [] if no PDFs were attached
  };

  /* ---------- 3e. POST to the PDF‑filler service ---------- */
  try {
    const resp = await fetch(BACKEND_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await resp.json();

    if (result.status === 'ok') {
      /* ---- 3f. Trigger download of the filled PDF ---- */
      const b64 = result.filledPdf.data;
      const binary = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      const blob = new Blob([binary], { type: result.filledPdf.mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = result.filledPdf.name;   // e.g. Procedural_Error_Notice_Filled.pdf
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      alert('✅ Form submitted – the filled PDF has been downloaded.');
    } else {
      alert('❗️ Something went wrong: ' + (result.message || 'unknown error'));
    }
  } catch (err) {
    console.error(err);
    alert('❗️ Network error – could not reach the PDF service.');
  }
});
</script>

</body>
</html>